---
- name: include vars
  include_vars: common.yml
- name: install packages
  become: yes
  action: apt pkg={{item}} state=installed
  with_items:
    - nginx
    - gunicorn

- name: pull ctfd
  git: repo=https://github.com/isislab/CTFd.git dest=~/CTFd force=yes
  register: ctfd_pulled

- name: run prepare.sh
  shell: ~/CTFd/prepare.sh
  register: prepareoutput
  when: ctfd_pulled|success

- name: copy gunicorn conf
  become: yes
  copy: src=files/ctfd_gunicorn.conf dest=/etc/gunicorn.d/ctfd force=yes

- name: write the nginx config file
  become: yes
  template:
    src: files/ctfd_nginx.conf.j2
    dest: /etc/nginx/sites-enabled/ctfd
    owner: root
    group: root
    mode: 0644
  notify:
      - restart nginx

- name: ensure nginx is running and enabled
  service: name=nginx state=started enabled=yes
